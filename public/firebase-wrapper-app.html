<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firebase SAML Redirect</title>
</head>
<body>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script>
    function setCookie(cName, cValue, expMinutes) {
      let date = new Date();
      date.setTime(date.getTime() + expMinutes * 60 * 1000);
      const expires = "expires=" + date.toUTCString();
      document.cookie = cName + "=" + cValue + "; " + expires + "; path=/";
    }

    function getCookie(cName) {
      const name = cName + "=";
      const cDecoded = decodeURIComponent(document.cookie);
      const cArr = cDecoded.split("; ");
      for (let val of cArr) {
        if (val.indexOf(name) === 0) return val.substring(name.length);
      }
      return null;
    }

    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());

    const app = firebase.initializeApp({
      apiKey: params["apiKey"],
      authDomain: params["authDomain"],
    });

    const provider = new firebase.auth.SAMLAuthProvider("saml.gt-sso");

    const linkingUri = params["linkingUri"] || "";

    if (linkingUri.includes("saml-sign-in")) {
      if (getCookie("redirecting") === "true") {
        setCookie("redirecting", "false", 5);

        app.auth().getRedirectResult()
          .then(result => {
            if (result && result.credential) {
              const credentialJSON = JSON.stringify(result.credential.toJSON());
              const redirectUrl = new URL(linkingUri);
              redirectUrl.searchParams.set("credential", credentialJSON);
              window.location.replace(redirectUrl.toString());
            } else {
              // No credential returned â€” this causes the Firebase error
              alert("SSO sign-in failed or was cancelled. Please try again.");
              console.warn("No credential in redirect result:", result);
            }
          })
          .catch(error => {
            console.error("Error in getRedirectResult:", error);
            alert("Error during SSO sign-in: " + error.message);
          });

      } else {
        setCookie("redirecting", "true", 5);
        app.auth().signInWithRedirect(provider);
      }

    } else if (linkingUri.includes("saml-reauth")) {
      // Optional: Implement reauth flow if needed
      alert("Reauth flow not implemented.");
    }
  </script>
  <p>You should be redirected in a moment. If not, try reloading the page.</p>
</body>
</html>
